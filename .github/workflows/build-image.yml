name: Build School Image

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Tag image per sekolah (mis. school-01)"
        required: true
      laravel_repo:
        description: "URL git untuk proyek Laravel"
        required: true
        default: https://github.com/MMT-Indonesia/absensi-laravel-vue
      laravel_ref:
        description: "Branch/tag Laravel"
        required: false
        default: main
      ci_a_repo:
        description: "URL git untuk CodeIgniter A"
        required: true
        default: https://github.com/MMT-Indonesia/mmt-tagihan-baru-dafi
      ci_a_ref:
        description: "Branch/tag CodeIgniter A"
        required: false
        default: main
      ci_b_repo:
        description: "URL git untuk CodeIgniter B"
        required: true
        default: https://github.com/MMT-Indonesia/mobile-akademik-holistik
      ci_b_ref:
        description: "Branch/tag CodeIgniter B"
        required: false
        default: main
      push_latest:
        description: "Push tag tambahan 'latest'"
        required: false
        default: "false"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      GIT_USERNAME: ${{ secrets.PRIVATE_GIT_USERNAME }}
      GIT_TOKEN: ${{ secrets.PRIVATE_GIT_TOKEN }}

    steps:
      - name: Checkout template repo
        uses: actions/checkout@v4

      - name: Set lowercase owner
        id: owner
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner_lc=$OWNER_LC" >> $GITHUB_ENV
          echo "ðŸ”¡ Repository owner lowercase: $OWNER_LC"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push image to GHCR
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ env.owner_lc }}/school:${{ inputs.image_tag }}
          build-args: |
            LARAVEL_REPO=${{ inputs.laravel_repo }}
            LARAVEL_REF=${{ inputs.laravel_ref }}
            CI_A_REPO=${{ inputs.ci_a_repo }}
            CI_A_REF=${{ inputs.ci_a_ref }}
            CI_B_REPO=${{ inputs.ci_b_repo }}
            CI_B_REF=${{ inputs.ci_b_ref }}
            GIT_USERNAME=${{ env.GIT_USERNAME }}
            GIT_TOKEN=${{ env.GIT_TOKEN }}

      - name: Push latest tag (GHCR)
        if: inputs.push_latest == 'true'
        run: |
          docker tag ghcr.io/${{ env.owner_lc }}/school:${{ inputs.image_tag }} ghcr.io/${{ env.owner_lc }}/school:latest
          docker push ghcr.io/${{ env.owner_lc }}/school:latest

      # ðŸ§© Tambahan: Mirror image ke Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Tag and push to Docker Hub
        run: |
          docker tag ghcr.io/${{ env.owner_lc }}/school:${{ inputs.image_tag }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/school:${{ inputs.image_tag }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/school:${{ inputs.image_tag }}

          if [ "${{ inputs.push_latest }}" = "true" ]; then
            docker tag ${{ secrets.DOCKERHUB_USERNAME }}/school:${{ inputs.image_tag }} \
              ${{ secrets.DOCKERHUB_USERNAME }}/school:latest
            docker push ${{ secrets.DOCKERHUB_USERNAME }}/school:latest
          fi
